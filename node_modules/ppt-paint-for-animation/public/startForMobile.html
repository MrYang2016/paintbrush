<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" />
  <title>Document</title>
  <!-- <link rel="stylesheet" href="./dist/index.css"> -->
</head>

<body>
  <div id="content"></div>
  <div style='position:fixed;top:0;left:0;color:red;font-size: 50px;'>10:18</div>
  <script type="text/javascript" src="/dist/index.js"></script>
  <script>
    var pptCtrl;
    addHandler(window, 'load', function () {
      if (!PPTH5) return;
      pptCtrl = new PPTH5({
        canEditPaint:true
      });

      refreshPPT('{"EVENT":"onSliceStart","data":{"autoId":41335,"isCamClosed":0,"pageId":0},"pushtime":1537329056954,"roomId":"225034","sessionId":"f4xr7uabdp","timeStamp":"0"}');
      setTimeout(() => {
        refreshPPT('{"EVENT":"onSliceDraw","data":{"ID":0,"autoId":47100,"clientHeight":526,"clientWidth":702,"color":"#ff0000","content":"","font":"微软雅黑","pageId":0,"points":[{"x":227,"y":60},{"x":226,"y":60},{"x":225,"y":62},{"x":225,"y":63},{"x":225,"y":66},{"x":225,"y":69},{"x":225,"y":75},{"x":226,"y":80},{"x":230,"y":88},{"x":232,"y":96},{"x":235,"y":106},{"x":241,"y":118},{"x":245,"y":130},{"x":250,"y":140},{"x":255,"y":150},{"x":262,"y":162},{"x":268,"y":174},{"x":281,"y":214},{"x":282,"y":227},{"x":284,"y":241},{"x":287,"y":253},{"x":291,"y":265},{"x":294,"y":287},{"x":296,"y":294},{"x":298,"y":302},{"x":299,"y":311},{"x":301,"y":317},{"x":304,"y":322},{"x":304,"y":323},{"x":304,"y":326},{"x":305,"y":327}],"pointscount":31,"size":3,"timeStamp":21466,"type":"line"},"roomId":"225034"}');
      }, 2000);

    });

    connectWebViewJavascriptBridge(function (bridge) {
      if (!bridge) {
        console.error('WebViewJavascriptBridge连接失败');
        return;
      }
      var playCtr = null;
      bridge.init(function (message, responseCallback) { });
      bridge.registerHandler('refreshPPT', function (data, responseCallback) {
        console.log('收到ppt信息');
        responseCallback('收到ppt信息');
        refreshPPT(data);
      });
      bridge.registerHandler('videoStart', function (data, responseCallback) {
        if (!data) {
          console.log('videoStart获取画笔数据为空');
          responseCallback('videoStart获取画笔数据为空');
          return;
        }
        console.log('收到请求画笔数据需要的信息');
        responseCallback('收到请求画笔数据需要的信息');
        videoStart(data).then(function (result) {
          if (!result) return;
          bridge.callHandler('pptPrepare', {}, function () {
            if (pptCtrl) playCtr = pptCtrl.VODPlay(getCurrentTime);
          });
        });
      });
      bridge.registerHandler('pptPlay', startAndStop('play'));
      bridge.registerHandler('pptPause', startAndStop('stop'));
      bridge.registerHandler('pptSeek', function (data, responseCallback) {
        if (!data) {
          console.log('pptSeek获取画笔跳转数据为空');
          responseCallback('pptSeek获取画笔跳转数据为空');
          return;
        }
        console.log('pptSeek获取画笔跳转数据成功');
        responseCallback('pptSeek获取画笔跳转数据成功');
        pptSeek(data);
      });
    });

    function connectWebViewJavascriptBridge(callback) {
      if (window.WebViewJavascriptBridge) {
        if (callback instanceof Function) callback(WebViewJavascriptBridge);
      } else {
        console.log('移动端请求WebViewJavascriptBridge对象中........');
        addHandler(document, 'WebViewJavascriptBridgeReady', function () {
          if (callback instanceof Function) callback(WebViewJavascriptBridge);
        });
      }
    }

    function refreshPPT(data) {
      if (pptCtrl) pptCtrl.drawMsgFromSocket(data);
    }

    function videoStart(data) {
      if (pptCtrl) {
        return pptCtrl.VODStart(data);
      }
    }

    function getCurrentTime(callback) {
      if (WebViewJavascriptBridge) {
        WebViewJavascriptBridge.callHandler('videoDuration', {}, callback);
      }
    }

    function startAndStop(type) {
      return function (data, responseCallback) {
        if (!playCtr) {
          console.log('画笔未初始化');
          responseCallback('画笔未初始化');
          return;
        }
        playCtr[type]();
        responseCallback('获得开始播放信息');
      }
    }

    function pptSeek(data) {
      if (pptCtrl) pptCtrl.pptSeek(data);
    }

    function addHandler(element, type, handler) {
      if (element.addEventListener) {
        element.addEventListener(type, handler, false);
      } else if (element.attachEvent) {
        element.attachEvent('on' + type, handler);
      } else {
        element['on' + type] = handler;
      }
    }
  </script>
</body>


</html>